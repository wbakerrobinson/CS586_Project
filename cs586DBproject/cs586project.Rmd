---
title: "Capstone Survey Analysis"
author: "William Baker-Robinson and Kevin Ng"
date: "3/7/2020"
output:  
 html_document:
    theme: lumen
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
params:
  availSurv: NA
  projSurv: NA
  eligible: NA
  projInfo: NA
  host: NA
  dbName: NA
  username: NA
  password: NA
  rendered_by_shiny: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r param vars for python}
host <- params$host
dbName <- params$dbName
username <- params$username
password <- params$password
renderVal <- 4
```

```{python connect to database}
import psycopg2
import pandas

connected = True
dbData = False
student = 0

try:
    conn = psycopg2.connect(
      dbname = r.dbName,
      user = r.username,
      host = r.host,
      password = r.password
    )
except:
    print("ERROR: Unable to connect to database")
    connected = False
if(connected):
    conn.set_session(autocommit = TRUE)
    cur = conn.cursor()
    cur.execute("SELECT 1 FROM information_schema.tables WHERE table_name = 'student';")
    if(cur.fetchone() is None):
      ddl_run = 0
    else:
      ddl_run = 1
    data_exists = []
    has_data = 0
    # fix with None
    if(ddl_run):
      cur.execute("SELECT 1 FROM project;")
      if(cur.fetchone() is None):
        has_data = 0
      else:
        has_data = 1
      data_exists.append(has_data)
      cur.execute("SELECT 1 FROM grade;")
      if(cur.fetchone() is None):
        has_data = 0
      else:
        has_data = 1
      data_exists.append(has_data)
    else:
      data_exists.append(0)
      data_exists.append(0)
```

```{r check user uploads and clean}
UpdateProgress(renderVal, params$rendered_by_shiny)
#check to see if the user uploaded any docs
userData <- FALSE
availSurvBool <- FALSE
projSurvBool <- FALSE
eligibleBool <- FALSE

if(py$connected == TRUE){
  print("Connected to the DB this is where I am going to clean")
  if(py$ddl_run == 0 & !is.null(params$availSurv))
  {
    cleanAvailVec <- scheduling(params$availSurv)
    student <- cleanAvailVec[[1]]
    str(student)
    availSurvBool <- TRUE
  }
  if(!is.null(params$availSurv) | py$ddl_run == 1)
  {
    if(py$data_exists[1] == 0 & !is.null(params$projSurv) & !is.null(params$projInfo))
    {
      cleanProjVec <- projects(params$projSurv, params$projInfo) 
      project <- cleanProjVec[[1]]
      str(project)
      projSurvBool <- TRUE
    }
    if(py$data_exists[2] == 0 & !is.null(params$eligible))
    {
      cleanGradeVec <- grading(params$eligible)
      grade <- cleanGradeVec[[1]]
      str(grade)
      eligibleBool <- TRUE
    }
  }
}
UpdateProgress(renderVal, params$rendered_by_shiny)
```

```{python update or upload}
canQuery = False
if (connected == True and r.availSurvBool == True and ddl_run == False):
  print("Connected, user supplied data, and db is empty")
  commands = (
  """
  CREATE TABLE student(
    student_id integer PRIMARY KEY,
    name varchar(50) NOT NULL,
    email varchar(50) UNIQUE NOT NULL,
    CHECK (LENGTH(student_id) == 9)
    ) """,
    """
  CREATE TABLE availability(
    availability_id integer PRIMARY KEY,
    day_of_week integer NOT NULL,
    mtg_time integer NOT NULL,
    description integer NOT NULL,
    CHECK (description == 1 OR description == 0),
    CHECK (day_of_week >= 0 AND day_of_week <= 6),
    CHECK (mtg_time >= 0 AND mtg_time <= 17)
    ) """,
    """
  CREATE TABLE availability_rel(
    student_id integer REFERENCES student(student_id),
    availability_id integer REFERENCES availability(availability_id),
    PRIMARY KEY(student_id, availability_id)
    ) """,
  """
  CREATE TABLE availability_comments(
    student_id integer REFERENCES student(student_id),
    avail_comment text,
    unavailability text,
    other text,
    PRIMARY KEY(student_id)
    ) """,
  """
  CREATE TABLE project(
    project_id integer PRIMARY KEY,
    organization varchar(50),
    contact_name text,
    contact_email text,
    description text
    ) """,
  """
  CREATE TABLE project_rel(
    project_id integer REFERENCES project(project_id),
    student_id integer REFERENCES student(student_id),
    interest integer NOT NULL,
    confidence integer NOT NULL,
    comment text,
    CHECK (interest >= 0 AND interest <= 10),
    CHECK (confidence >= 0 AND confidence <= 5)
    ) """,
  """
  CREATE TABLE grade_rel(
    student_id integer REFERENCES student(student_id),
    grade_id integer REFERENCES grade(grade_id)
    PRIMARY KEY(student_id, grade_id)
    ) """,
  """
  CREATE TABLE grade(
    grade_id integer PRIMARY KEY,
    course integer NOT NULL,
    grade_value integer NOT NULL,
    CHECK (course >= 0 AND course <= 11),
    CHECK (grade_value >= 0 AND grade_value <= 21)
    ) """,
  """
  CREATE TABLE interested_in(
    student_id integer REFERENCES student(student_id),
    interested_id integer NOT NULL,
    comment text,
    CHECK (interested_id >= 0 AND interested_id <= 7)
    ) """,
  """
  CREATE TABLE skilled_in(
    student_id integer REFERENCES student(student_id),
    familiar_id integer NOT NULL,
    comment text,
    CHECK (familiar_id >= 0 AND familiar_id <= 7)
    ) """,
  """
  CREATE TABLE roll(
    student_id integer REFERENCES student(student_id),
    role_id integer NOT NULL,
    comment text,
    CHECK (role_id >= 0 AND role_id <= 4)
    ) """,
  """
  CREATE TABLE work_info(
    student_id integer REFERENCES student(student_id),
    strength text NOT NULL,
    weakness text NOT NULL,
    work integer NOT NULL,
    know_about text,
    other text 
    ) """,
  """
  CREATE TABLE interest(
    student_id integer REFERENCES student(student_id),
    interest_most text NOT NULL,
    interest_least text NOT NULL,
    cs_enjoy text NOT NULL
    ) """,
  """
  CREATE TABLE skill(
    student_id integer REFERENCES student(student_id),
    know_most text NOT NULL,
    know_least text NOT NULL,
    languages text NOT NULL
  """)
  try:
    for command in commmands:
      cur.execute(command)
    conn.commit()
  except (Exception, psycopg2.DatabaseError) as error:
    print(error)
  
  # run ddl 
  # upload all...
  canQuery = True
elif (connected == True and ddl_run == True):
  if(r.projSurvBool == True):
    print("project data will be uploaded here")
  if(r.eligibleBool == True):
    print("grade data will be uploaded here")
  else:
    print("Connected, and database is setup. No data to upload or database already has data")
  canQuery = True
elif(connected == True and r.availSurvBool == False and ddl_run == False):
  print("ERROR: Connected but no data exists in the database, and no data provided to add")
else:
  print("Not connected")
```


# 20 Questions     
## Interst Level  
### Count the number of students interested in each project:  
_# of students with interest level greater than 5_  

### Count the number of times a project was selected as a top 3 choice:  

### Are there more students who marked low interest in all projects than students who marked high interest in all projects?  
_How to define low vs. high interest?_  

### Output a list of the 5 students who have the highest interest level for each project:  

### Create a scatterplot of interest level and confidence to complete each project:  

### What skills are students most interested in?  

## Availability  
### When are most students available?  
_Create a heatmap_

### Plot students time availability stratified by 1st choice of project:  

### Plot students time availability stratified by 2nd choice of project:  

### Plot students time availability stratified by 3rd choice of project:  

### What proportion of students perfer times before 10:00 Am?

### What proportion of students are available past 6:00 Pm? 

## Skills
### What are the 5 most common skills?  

### What are the 5 least common skills?  

### What is the most common skill among those who got straight Aâ€™s in their prerequisite courses?  
_Do they have to have an A in all pre-reqs? How many people actually did this?_  

### Return a list of the 5 students who are most confident in their ability to complete each project:  

### Create a histogram of the students confidence level in completing each project:  

### Create a barchart of the skills students are skilled in or familiar with:  

## Eligibility
### How many students do not meet eligibility criteria?   

### Where do skills not match with eligibility criteria?  
_May be hard to match skills and classes taken..._  

### What is the average confidence level of students who do not meet eligibility criteria for each project?  


```{python}
if(connected):
  conn.close()
```

